
@{
    ViewData["Title"] = "FlightSearch";
}

<h1>FlightSearch</h1>


<form asp-controller="FlightSearch" asp-action="Search" method="post">
    <h2>Aeropuerto de origen</h2>
    <select id="desplegable">
        <option value="">Seleccione una opción</option>
        @foreach (var opcion in ViewBag.Countries.Countries)
        {
            <option value="@Json.Serialize(opcion)">@opcion.Name</option>
        }
    </select>
    <div class="form-group">
        <label for="origin">Origen:</label>
         <input type="text" id="origin" placeholder="Ciudad de origen" required>
        <select id="originOptions" name="originOptions" style="display: none;" required></select> <!-- Select oculto para mostrar las opciones filtradas -->
    </div>
     <h2>Aeropuerto de destino</h2>
    <select id="countryDestino">
        <option value="">Seleccione una opción</option>
        @foreach (var opcion in ViewBag.Countries.Countries)
        {
            <option value="@Json.Serialize(opcion)">@opcion.Name</option>
        }
    </select>
    <div class="form-group">
        <label for="destination">Destino:</label>
        <input type="text" id="destination" placeholder="Ciudad de destino" required>
        <select id="destinationOptions" name="destinationOptions" style="display: none;" required></select>
    </div>
    <div class="form-group">
        <label for="departureDate">Fecha de salida:</label>
        <input type="date" id="departureDate" name="departureDate" required>
    </div>
    <div class="form-group">
        <label for="returnDate">Fecha de regreso:</label>
        <input type="date" id="returnDate" name="returnDate">
    </div>
    <div class="form-group">
        <input type="submit" value="Buscar vuelos">
    </div>

    <div class="form-group">
        <label for="numPasajeros">Número de pasajeros:</label>
        <input type="number" id="numPasajeros" name="numPasajeros" min="1" required>
    </div>
</form>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>

    var typingTimer;                // Variable para almacenar el temporizador
    var doneTypingInterval = 1000;  // Tiempo de espera en milisegundos (en este caso, 1 segundo)

    $(document).ready(function () {
        $('#origin').on('input', function () {
            clearTimeout(typingTimer);  // Reinicia el temporizador en cada escritura
            typingTimer = setTimeout(performSearch, doneTypingInterval);  // Establece el temporizador
        });
    });
    $(document).ready(function () {
        $('#destination').on('input', function () {
            clearTimeout(typingTimer);  // Reinicia el temporizador en cada escritura
            typingTimer = setTimeout(performSearchDestination, doneTypingInterval);  // Establece el temporizador
        });
    });
   
    function performSearch() {
        var inputText = $('#origin').val();
        var selectedCountry = JSON.parse($('#desplegable').val());
        console.log(selectedCountry);
        console.log(selectedCountry.code);
        if (inputText.length >= 3 && selectedCountry !== null) {
            $.ajax({
                url: '@Url.Action("GetFilteredAirports", "FlightSearch")' + '?searchText=' + encodeURIComponent(inputText) + '&country=' + encodeURIComponent(selectedCountry.code),
                method: 'GET',
                success: function (data) {
                    // Limpiar y mostrar el select con las opciones filtradas
                    var select = $('#originOptions');
                    select.empty();
                    $.each(data, function (index, option) {
                        select.append('<option value="' + option.value + '">' + option.text + '</option>');
                    });
                    select.show(); // Mostrar el select una vez que se han agregado las opciones
                },
                error: function () {
                    console.error('Error al obtener las opciones filtradas');
                }
            });
        } else {
            // Si el campo de origen tiene menos de tres caracteres, ocultar el select
            $('#originOptions').hide();
        }
    }
    function performSearchDestination() {
        var inputText = $('#destination').val();
        var selectedCountry = JSON.parse($('#countryDestino').val());
        console.log(selectedCountry);
        console.log(selectedCountry.code);
        if (inputText.length >= 3 && selectedCountry !== null) {
            $.ajax({
                url: '@Url.Action("GetFilteredAirports", "FlightSearch")' + '?searchText=' + encodeURIComponent(inputText) + '&country=' + encodeURIComponent(selectedCountry.code),
                method: 'GET',
                success: function (data) {
                    // Limpiar y mostrar el select con las opciones filtradas
                    var select = $('#destinationOptions');
                    select.empty();
                    $.each(data, function (index, option) {
                        select.append('<option value="' + option.value + '">' + option.text + '</option>');
                    });
                    select.show();
                },
                error: function () {
                    console.error('Error al obtener las opciones filtradas');
                }
            });
        } else {
            // Si el campo de origen tiene menos de tres caracteres, ocultar el select
            $('#originOptions').hide();
        }
    }
</script>





